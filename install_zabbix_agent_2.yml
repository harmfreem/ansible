    - name: Kill any existing zabbix_agentd.exe processes
      win_shell: |
        Get-Process -Name zabbix_agentd -ErrorAction SilentlyContinue | Stop-Process -Force
      ignore_errors: true

    - name: Remove old Zabbix Agent service if exists
      win_shell: |
        if (Get-Service -Name "Zabbix Agent" -ErrorAction SilentlyContinue) {
          Stop-Service -Name "Zabbix Agent" -Force
          sc.exe delete "Zabbix Agent"
        }
      ignore_errors: true

    - name: Delete old Zabbix installation folder (if exists)
      win_file:
        path: "C:\\Program Files\\Zabbix Agent"
        state: absent
      ignore_errors: true

    - name: Clean old Zabbix registry keys (optional)
      win_regedit:
        path: 'HKLM\\SOFTWARE\\Zabbix SIA'
        state: absent
      ignore_errors: true

    - name: Reboot before reinstall (to clear locked files/services)
      win_reboot:
        msg: "Rebooting before Zabbix Agent installation to clean up."
        reboot_timeout: 600
